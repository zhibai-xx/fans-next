# 🛠️ .cursorrules 项目坑点规范更新

## 🎯 **更新背景**

用户在开发过程中反复遇到相同的技术问题：
1. **端口混淆**：`localhost:3001` vs `localhost:3000`
2. **API路径重复**：`/api/api/xxx` 错误
3. **数据字段访问**：`media.tags` vs `media.media_tags` 

这些问题多次导致bug，浪费调试时间。用户要求在 `.cursorrules` 文件中添加项目特定知识，预防重复犯错。

## ✨ **新增规范内容**

### 🚨 **关键坑点 - 必须严格遵守**

#### **1. 端口访问规则**
```
❌ 错误：前端代码中直接访问 http://localhost:3001/api/xxx（这是后端直接端口）
✅ 正确：前端代码中应访问 http://localhost:3000/api/xxx（通过Next.js代理）
🔧 调试时：可以直接curl http://localhost:3001/api/xxx 验证后端，但前端代码必须用3000端口
```

#### **2. 前端API服务BASE_URL配置**
```typescript
❌ 错误：BASE_URL = '/api/media/interaction' → 导致请求 /api/api/media/interaction
✅ 正确：BASE_URL = '/media/interaction' → 正确请求 /api/media/interaction
📝 原因：Next.js代理已经添加了/api前缀，服务层不需要重复添加
🎯 规则：前端服务文件中的BASE_URL永远不要以/api开头
```

#### **3. 媒体标签数据字段访问**
```typescript
// ❌ media.tags - 直接标签数组（通常为空）
media.tags: Tag[]

// ✅ media.media_tags - 标签关联表数据（包含实际数据）
media.media_tags: Array<{
  tag: { id: string, name: string }
}>

// ✅ 正确的标签提取方式
tags: media.media_tags?.map(mediaTag => ({
  id: mediaTag.tag.id,
  name: mediaTag.tag.name
})) || []
```

#### **4. 数据映射完整性检查**
```
🎯 必须映射的字段：在收藏页面等数据转换中，必须映射所有关键字段
✅ 必须包含：size, width, height, duration, status, source, updated_at 等
❌ 避免硬编码：不要使用 size: 0, width: 0 等硬编码值
📋 检查清单：每次做数据转换时，对比API响应和接口定义，确保所有字段都正确映射
```

## 🔧 **检查清单更新**

### **API调用问题检查清单**（新增）
1. **端口和路径检查**：
   - 确认前端请求使用3000端口，不是3001端口
   - 确认BASE_URL不重复包含`/api`（避免`/api/api/xxx`错误）
   - 检查接口路径是否正确（特别是登录接口）

2. **数据字段映射检查**：
   - 标签数据使用`media.media_tags`而不是`media.tags`
   - 确保所有关键字段都正确映射（size、width、height等）
   - 避免硬编码数值（如size: 0, width: 0）

### **重要提醒**（新增专门章节）
```
🚨 项目特定坑点预防：
- 端口混淆预防：前端代码永远使用3000端口，3001只用于后端直接调试
- API路径重复预防：前端服务BASE_URL永远不以/api开头，避免/api/api/xxx错误
- 数据字段访问预防：媒体标签永远使用media.media_tags，不要使用media.tags
- 数据映射完整性：每次数据转换必须对比API响应，确保所有字段正确映射，禁止硬编码
```

## 📈 **预期效果**

### **问题预防**
- ✅ **端口错误**：开发时立即知道用哪个端口，避免混淆
- ✅ **API路径重复**：前端服务配置时自动避免`/api/api/`错误
- ✅ **标签数据空白**：优先使用`media.media_tags`，确保标签正确显示
- ✅ **数据映射不完整**：每次转换时检查所有字段，避免硬编码

### **开发效率**
- 🚀 **减少调试时间**：遇到问题时快速定位常见坑点
- 🎯 **防患于未然**：开发时就避免犯这些错误
- 📋 **规范化开发**：统一的最佳实践和检查清单
- 🔄 **知识传承**：新团队成员也能快速了解项目坑点

## 🔗 **相关历史问题**

这些坑点在以往开发中的实际影响：

| 问题类型 | 出现次数 | 影响功能 | 修复难度 |
|----------|----------|----------|----------|
| 端口混淆 | 多次 | API请求失败 | 中等 |
| API路径重复 | 多次 | 404错误 | 容易 |
| 标签字段错误 | 多次 | 标签不显示 | 困难 |
| 数据映射不完整 | 多次 | 详情显示异常 | 困难 |

## 🎉 **总结**

通过这次 `.cursorrules` 文件的更新，我们将项目中最常见的坑点整理成了系统化的开发规范。这不仅能帮助避免重复性错误，还能提高整体的开发效率和代码质量。

**核心价值**：
- 🛡️ **预防性编程**：在写代码之前就知道要避免的问题
- 📚 **知识沉淀**：将踩坑经验转化为规范化知识
- 🚀 **效率提升**：减少调试时间，专注于功能开发
- 🎯 **质量保障**：从源头避免bug，提高代码稳定性

---

**更新时间**：2025-01-08  
**更新内容**：添加4类关键坑点规范和对应检查清单  
**预期效果**：显著减少项目特定bug的重复出现率
